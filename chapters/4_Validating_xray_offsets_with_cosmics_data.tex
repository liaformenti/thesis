% ==================================================
% CHAPTER 4: Validating x-ray alignment parameters with cosmic muon data %
% ==================================================

\chapter{Validating x-ray alignment parameters with cosmic muon data}
\label{chap:comparison}
% Edit count: Lia - 0, Brigitte - 0

The goal was to validate the local offsets extracted from the x-ray data with cosmics data. The complication was that the x-ray dataset provided absolute local offsets while the cosmics dataset provided relative local offsets, which could not be compared directly. The solution was to analyze the x-ray data in the same relative coordinate system as the cosmics data. The methods and results of the comparison are presented here.

% --------------------------------------------------
\section{Method for comparing x-ray and cosmics data}
% --------------------------------------------------
%TODO : determine if the description of equation 1.1 is suitably general enough to describe the x-ray data

The measured x-ray beam profile centers were systematically affected by local offsets in the same way as the mean cosmics residuals, as modeled by equation \ref{eqn:local_translation}. Therefore, if a 2-layer track is abstracted from the beam profile centers on each layer and the residual calculated on a third layer, that residual should match the local mean cosmics residual. 

The track is "abstracted" because a so-called "beam profile center" is actually the Gaussian mean of all selected mean cluster positions recorded during the x-ray data taking period. Abstracting a track was necessary because the x-rays cause signal in the chamber via the photoeffect so there were not individual "x-ray tracks" to record. In fact the x-ray data was collected separately for each layer. Nonetheless, since the effect of local offsets on the beam profile centers was the same the difference in algorithm between x-ray and cosmics analysis was allowed. 

For each x-ray survey position, the x-ray residual was calculated for all possible tracking combinations (which required an x-ray beam profile on at least three layers). The position of the x-ray residuals are shown as black dots over figure~\ref{fig:res_mean_th2_L2_F13} and \ref{fig:res_mean_th2_L4_F13}. Note that the mean of cosmics residuals around the x-ray points were calculated in bins exactly centered on the nominal x-ray gun position, unlike in figure~\ref{fig:res_mean_th2}.

%---------------------------------------------------
\section{Assessing correlation}
%---------------------------------------------------
Scatter plots of the x-ray and mean cosmics residuals for two sample quadruplets in figures~\ref{fig:correlation} and \ref{fig:no_correlation} reveal the degree of correlation between the datasets.

\begin{figure}
    \centering
    \includegraphics[width = \textwidth]{figures/figure_QL2P11_3100V_2021-08-05_QL2P11_local_cosmic_and_xray_data_correlation_plot.pdf}
    \caption{Correlation plot between x-ray and cosmics residuals for all tracking combinations for QL2.P.11. Each rectangle is centered on an x-ray and mean cosmics residual pair. The width of the rectangles in $x$ and $y$ are the uncertainty in the x-ray and mean cosmics residual respectively.}
    \label{fig:correlation}
\end{figure}

First, the fitted slope and offset in figure~\ref{fig:correlation} show that the two QL2.P.11 datasets are correlated. However, the magnitude of the uncertainties in the x-ray residuals is large (up to half a millimeter) since it comes from propagating the \SI{120}{\micro\meter} uncertainty in the beam profile centers. The large uncertainty set a limit on the sensitivity of the analysis, for if the absolute value of the x-ray residuals of a quadruplet were smaller than the x-ray residual uncertainties, no conclusion about the correlation could be drawn, like for QL2.P.8 (figure~\ref{fig:no_correlation}).

\begin{figure}
    \centering
    \includegraphics[width = \textwidth]{figures/figure_QL2P08_3100V_2021-08-16_QL2P08_local_cosmic_and_xray_data_correlation_plot.pdf}
    \caption{Correlation plot between x-ray and cosmics residuals for all tracking combinations for QL2.P.8.}
    \label{fig:no_correlation}
\end{figure}

Several quadruplets were tested for each quadruplet construction geometry built in Canada: QL2P, QL2C, and QS3P. Each quadruplet fell into one of the two categories: residuals large enough to see a correlation, or residuals too small to see a correlation. Since the x-ray and mean cosmics residuals were measures of the relative local offsets between the layer of a quadruplet and the two reference layers, quadruplets with the most relative misalignment had the largest range of residuals. So, the correlation plots were an easy visual way to identify quadruplets with large relative misalignments.

There are three patterns in the residuals on the scatter plot explained by geometry. First, for both datasets the uncertainty in the extrapolated track residuals were larger than the interpolated track residuals because of the extrapolation lever arm. For the x-ray residuals, the effect of the lever arm on the uncertainty was direct since the residual was calculated from a single abstracted track; for the cosmics residuals it was the widening of the residual distribution on the layer of interest due to the extrapolation lever arm that increased the statistical uncertainty in the fitted mean of residuals. Second, residuals calculated through extrapolation tend to be larger because the extrapolation lever arm can produce more extreme values. Third, the pattern of points in figure~\ref{fig:correlation} is slightly mirrored. This is expected since the residuals calculated for a given set of three layers are geometrically correlated. 

The correlation of the cosmics residuals with the x-ray residuals alone does not validate the analysis method~---~all the studies in described in appendices~\ref{appendix:statistics} and ~\ref{appendix:systematics} demonstrate its robustness. The analysis could be validated externally by comparing the mean cosmics residuals to the relative misalignment parameters calculated using \package{tgc\_analysis/MatrixMethod} and JOHN FLORES CHI2 METHOD.

% --------------------------------------------------
\section{Limitations and next steps}
% --------------------------------------------------
The most important limit on measuring the degree of correlation between the x-ray and cosmics residuals is the uncertainty on the x-ray residuals, which stems from the uncertainty in the x-ray beam profile centers. The uncertainty mostly comes from systematic effects~\cite{lefebvre_precision_2020}, but the working group decided that the gains in confidence that more work on the method would provided were no longer a valuable use of time. They were limited primarily by the fact that sTGCs do not have good x-ray position resolution since x-rays do not create real tracks. 

The analysis for certain quadruplets was also limited by the availability of data. Sometimes, less than three layers were surveyed for a given x-ray gun position so no residuals could be calculated. Too few x-ray residuals prevent the analysis from detecting a significant correlation. Often, the analysis of smaller quadruplets suffered as a result because they have fewer possible gun positions in the first place. In addition, the analysis was limited to certain quadruplets because: the earliest constructed wedges (typically small wedges) were surveyed when the method was still under design and so have limited x-ray residuals calculated from beam profiles of lower quality; and data suitable for \package{tgc\_analysis/CosmicsAnalysis}~\cite{lefebvre_tgc_analysis} was not collected for all quadruplets globally because \package{tgc\_analysis/CosmicsAnalysis}~\cite{lefebvre_tgc_analysis} requires front end electronics for at least three gas volumes, which not all cosmic muon testing sites had.

Nonetheless, the comparison of x-ray and cosmics residuals was really to improve confidence in the x-ray data since it is used to define an absolute misalignment model for each quadruplet~\cite{lefebvre_precision_2020} to be input into \package{Athena}~\cite{the_atlas_collaboration_athena}~---~which this analysis succeeds in providing. Next all quadruplets with cosmics data suitable for \package{tgc\_analysis/CosmicsAnalysis}~\cite{lefebvre_tgc_analysis} should be surveyed to weed out anomalous x-ray data and quantify the correlation between x-ray and cosmics data over all quadruplets instead of individually. For now, the results for individual quadruplets support the use of the x-ray data to build a global misalignment model. Work on creating a misalignment model is ongoing with the development of \package{stgc\_as\_built\_fit}~\cite{lefebvre_stgc_as_built_fit}. Currently, the algorithm compares the y-position of a local group of strips at each x-ray gun position as measured by the x-ray and CMM methods in a $\chi^2$ fit. The CMM measurements were taken before the cathode boards were assembled into quadruplets, so misalignment parameters for the given layer were extracted from the $\chi^2$ fit by stepping the CMM y-value towards the x-ray y-value by adjusting the misalignment parameters (currently, a rotation and global offset). 

Figure~\ref{fig:correlation} and \ref{fig:no_correlation} clearly show that the uncertainty in the mean cosmics residuals, which is the sum in quadrature of the statistical and assigned systematic uncertainties (table~\ref{tab:sys_uncerts}), was much smaller than the uncertainty in the x-ray residuals. It is a result of the uncertainty in the cosmic muon hit positions on each layer being smaller than the uncertainty on the x-ray beam profile centers. Therefore, it would be great to use the cosmics residuals as input to calculate and reduce the uncertainty on the misalignment parameters. Since mean cosmics residuals can only provide relative misalignment information, one idea would be to constrain the fit of the alignment parameters by fitting the alignment parameters for all layers at once, and forcing the shifting y-values on each layer to result in abstracted track residuals equal to the mean cosmics residuals within their uncertainty. Or, instead of constraining the fit, it could be penalized if the resulting parameters do not result in abstracted track residuals equal to the mean cosmics residuals within uncertainty. 

